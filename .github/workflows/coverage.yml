name: Coverage

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:

  coverage:
    name: Coverage (+nightly)
    # The large timeout is to accommodate nightly builds
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
      CARGO_INCREMENTAL: 0
      RUST_BACKTRACE: full

    steps:
      - uses: actions/checkout@v2.4.0
        with:
          persist-credentials: false

      - uses: actions-rs/toolchain@v1.0.7
        with:
          toolchain: nightly
          override: true
          profile: minimal
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov cargo command
        run: cargo install cargo-llvm-cov

      - name: Skip network tests on Ubuntu
        # Ubuntu runners don't have network or DNS configured during test steps
        if: matrix.os == 'ubuntu-latest'
        run: echo "ZEBRA_SKIP_NETWORK_TESTS=1" >> $GITHUB_ENV

      - name: Show env vars
        run: |
            echo "ZEBRA_SKIP_NETWORK_TESTS=${{ env.ZEBRA_SKIP_NETWORK_TESTS }}"
            echo "CARGO_INCREMENTAL=${{ env.CARGO_INCREMENTAL }}"
            echo "RUST_BACKTRACE=${{ env.RUST_BACKTRACE }}"

      - name: Pre-download Zcash Sprout and Sapling parameters
        uses: actions-rs/cargo@v1.0.3
        with:
          command: run
          args: --verbose --bin zebrad download

      - name: Generate code coverage
        run: cargo llvm-cov --lcov > lcov.info

      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v2.1.0
