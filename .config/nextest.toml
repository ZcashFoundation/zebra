# Nextest configuration for Zebra
# This file centralizes test execution configuration, timeouts, and retries.
# Uses per-test overrides with filtersets to eliminate conditional logic in entrypoint.sh.
#
# Advanced Filtersets Used:
# - `package(name)` - Target specific packages/crates
# - `test(=name)` - Exact test name matching
# - `test(~pattern)` - Contains matching for test names
# - `package(pkg) and test(pattern)` - Combined package + test filtering
# - Eliminates need for --package, --lib, --test flags in entrypoint.sh
#
# Reference: https://nexte.st/docs/configuration/per-test-overrides/

[profile.default]
retries = 0
fail-fast = true
status-level = "fail"

# CI profile for comprehensive testing (excludes only the longest-running tests)
[profile.ci]
retries = 1
fail-fast = false
status-level = "fail"

[[profile.ci.overrides]]
filter = 'not test(=check_no_git_dependencies)'

# Profiles for specific test categories using per-test overrides

[profile.check-no-git-dependencies]
retries = 0

[[profile.check-no-git-dependencies.overrides]]
filter = 'test(=check_no_git_dependencies)'

[profile.state-fake-activation-heights]
retries = 0
slow-timeout = { period = "10m", terminate-after = 1 }

[[profile.state-fake-activation-heights.overrides]]
filter = 'package(zebra-state) and test(~with_fake_activation_heights)'

# Sync tests - using per-test overrides for better targeting
[profile.sync-large-checkpoints-empty]
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 2

[[profile.sync-large-checkpoints-empty.overrides]]
filter = 'package(zebrad) and test(=sync_large_checkpoints_empty)'

[profile.sync-full-mainnet]
slow-timeout = { period = "120m", terminate-after = 1 }
retries = 3

[[profile.sync-full-mainnet.overrides]]
filter = 'package(zebrad) and test(=sync_full_mainnet)'

[profile.sync-full-testnet]
slow-timeout = { period = "120m", terminate-after = 1 }
retries = 3

[[profile.sync-full-testnet.overrides]]
filter = 'package(zebrad) and test(=sync_full_testnet)'

[profile.sync-to-mandatory-checkpoint]
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 2

[[profile.sync-to-mandatory-checkpoint.overrides]]
filter = 'package(zebrad) and test(~sync_to_mandatory_checkpoint_)'

[profile.sync-update-mainnet]
slow-timeout = { period = "30m", terminate-after = 2 }
retries = 1

[[profile.sync-update-mainnet.overrides]]
filter = 'package(zebrad) and test(=sync_update_mainnet)'

[profile.sync-past-mandatory-checkpoint]
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 2

[[profile.sync-past-mandatory-checkpoint.overrides]]
filter = 'package(zebrad) and test(~sync_past_mandatory_checkpoint_)'

[profile.generate-checkpoints-mainnet]
slow-timeout = { period = "90m", terminate-after = 1 }
retries = 2

[[profile.generate-checkpoints-mainnet.overrides]]
filter = 'package(zebrad) and test(=generate_checkpoints_mainnet)'

[profile.generate-checkpoints-testnet]
slow-timeout = { period = "90m", terminate-after = 1 }
retries = 2

[[profile.generate-checkpoints-testnet.overrides]]
filter = 'package(zebrad) and test(=generate_checkpoints_testnet)'

# LWD tests - using per-test overrides and test-threads
[profile.lwd-rpc-test]
test-threads = 1  # Run sequentially to avoid conflicts
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 1

[[profile.lwd-rpc-test.overrides]]
filter = 'package(zebrad) and test(=lwd_rpc_test)'

[profile.lwd-integration]
slow-timeout = { period = "30m", terminate-after = 2 }
retries = 1

[[profile.lwd-integration.overrides]]
filter = 'package(zebrad) and test(=lwd_integration)'

[profile.lwd-sync-full]
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 1

[[profile.lwd-sync-full.overrides]]
filter = 'package(zebrad) and test(=lwd_sync_full)'

[profile.lwd-sync-update]
slow-timeout = { period = "30m", terminate-after = 2 }
retries = 1

[[profile.lwd-sync-update.overrides]]
filter = 'package(zebrad) and test(=lwd_sync_update)'

[profile.lwd-grpc-wallet]
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 1

[[profile.lwd-grpc-wallet.overrides]]
filter = 'package(zebrad) and test(=lwd_grpc_wallet)'

[profile.lwd-rpc-send-tx]
slow-timeout = { period = "30m", terminate-after = 2 }
retries = 1

[[profile.lwd-rpc-send-tx.overrides]]
filter = 'package(zebrad) and test(=lwd_rpc_send_tx)'

# RPC tests
[profile.rpc-get-block-template]
slow-timeout = { period = "30m", terminate-after = 2 }
retries = 1

[[profile.rpc-get-block-template.overrides]]
filter = 'package(zebrad) and test(=rpc_get_block_template)'

[profile.rpc-submit-block]
slow-timeout = { period = "30m", terminate-after = 2 }
retries = 1

[[profile.rpc-submit-block.overrides]]
filter = 'package(zebrad) and test(=rpc_submit_block)'

# Per-test timeout overrides using advanced filtersets
[[profile.default.overrides]]
filter = 'test(~sync_full_)'
slow-timeout = { period = "120m", terminate-after = 1 }
retries = 3

[[profile.default.overrides]]
filter = 'test(~generate_checkpoints_)'
slow-timeout = { period = "90m", terminate-after = 1 }
retries = 2

[[profile.default.overrides]]
filter = 'test(~lwd_) or test(~lightwalletd_)'
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 1

[[profile.default.overrides]]
filter = 'test(~sync_large_checkpoints_) or test(~sync_to_mandatory_checkpoint_) or test(~sync_past_mandatory_checkpoint_)'
slow-timeout = { period = "60m", terminate-after = 2 }
retries = 2

[[profile.default.overrides]]
filter = 'package(zebra-state) and test(~with_fake_activation_heights)'
# State tests should be deterministic
retries = 0
slow-timeout = { period = "10m", terminate-after = 1 }